name: Docker Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  docker-build-and-test:
    name: Build Docker Image and Test
    runs-on: ubuntu-latest
    
    env:
      CONTAINER_PORT: 8080
      CONTAINER_INTERNAL_PORT: 80
      CONTAINER_NAME: rising-force-test
      IMAGE_NAME: rising-force-offline:test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t "${{ env.IMAGE_NAME }}" .

      - name: Run Docker container
        run: |
          # Container exposes nginx on port specified by CONTAINER_INTERNAL_PORT, mapped to host CONTAINER_PORT
          docker run -d -p ${{ env.CONTAINER_PORT }}:${{ env.CONTAINER_INTERNAL_PORT }} \
            --name "${{ env.CONTAINER_NAME }}" "${{ env.IMAGE_NAME }}"
          echo "Container started successfully"

      - name: Wait for application and verify HTTP 200 OK
        run: |
          max_attempts=30
          attempt=0
          
          echo "Waiting for application to be ready..."
          while [ $attempt -lt $max_attempts ]; do
            # Get HTTP status code with timeouts to handle network issues gracefully
            status_code=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 5 --connect-timeout 3 \
              http://localhost:${{ env.CONTAINER_PORT }} || echo "000")
            
            if [ "$status_code" = "200" ]; then
              echo "✓ Success! Application is ready and returned HTTP $status_code"
              exit 0
            fi
            
            attempt=$((attempt + 1))
            echo "Waiting for application... attempt $attempt/$max_attempts (got HTTP $status_code)"
            sleep 2
          done
          
          echo "✗ Failed! Application did not become ready after $max_attempts attempts"
          echo "Container logs:"
          docker logs "${{ env.CONTAINER_NAME }}"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          docker stop --time 10 "${{ env.CONTAINER_NAME }}" || true
          docker rm "${{ env.CONTAINER_NAME }}" || true
